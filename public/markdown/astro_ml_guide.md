# AI4S 实践策略笔记与工程指引

## 0. 核心哲学：科学导向的工程学
* **AI4S $\neq$ 模型竞赛**：你的目标不是刷榜，而是**解决科学问题**。
* **科学价值 > 数值精度**：0.01 的精度提升如果缺乏物理可解释性或泛化能力，则毫无意义。
* **不确定性是必需品**：在科学决策中，没有误差棒（Error Bar）的预测是不可接受的。

## 一、 战略设定：从科学问题到决策目标

在写第一行代码前，必须通过**正交化**思维将模糊的科学愿景转化为可执行的工程目标。

### 1.1 定义科学决策句
不要问“我能用 ResNet 跑这个数据吗？”，而要问：
* **“给定观测数据 $X$，我们需要做出决策 $A$ 还是 $B$？”**
* 明确：谁在用模型？（望远镜调度员？理论物理学家？）输出结果如何反馈到科学分析链条中？

### 1.2 确立基线 (The Baseline Hierarchy)
严禁一上来就跑复杂的深度学习模型。必须严格遵循以下阶梯：
1.  **Dummy Baseline**：全零预测、均值预测或多数类预测。这是下限。
2.  **Historical Baseline**：现有文献中的传统方法（如随机森林、SVM 或经验公式）。
3.  **Initial Baseline**：你能快速跑通的简单神经网络（如 3 层 MLP 或 ResNet-18）。

### 1.3 评估指标体系
* **单一数字评估指标 (Single Number Metric)**：选择一个核心指标（如 $F_1$ Score 或卡方 $\chi^2$）作为迭代罗盘。
* **满足 vs. 优化 (Satisficing vs. Optimizing)**：
    * $$maximize \ Scientific \ Discovery \ Potential \ | \ subject \ to \ False \ Positive \ Rate \le 10^{-5}$$
    * 在 AI4S 中，**假阳性**的代价通常远高于假阴性（例如：不能把垃圾误报为引力波信号）。

## 二、 数据工程：物理一致性与分布偏移

科学数据不同于互联网数据，其核心难点在于**仿真 (Simulation) 与 观测 (Observation) 的鸿沟**。

### 2.1 数据集划分：对抗协变量偏移 (Covariate Shift)
* **核心挑战**：训练数据常来自仿真（完美标签），测试数据来自真实观测（含噪声、仪器效应）。
* **划分策略**：
    * **Train**：仿真数据 + 少量已标注真实数据。
    * **Dev/Test**：**必须全部由真实观测数据（或极高保真仿真）组成**。
    * **严禁**：随机混洗仿真和真实数据，这会掩盖“仿真-现实”差距（Sim2Real Gap）。

### 2.2 诊断数据不匹配
利用 **Train-Dev Set**（从训练分布中切分出的验证集）进行诊断：
* $Error_{train\_dev} - Error_{train}$ = **模型方差（过拟合仿真）**。
* $Error_{dev} - Error_{train\_dev}$ = **数据不匹配（Sim2Real Gap）**。
    * *对策*：领域自适应 (Domain Adaptation)、在仿真中加入物理噪声 (Instrumental Effects)、重加权 (Importance Weighting)。

### 2.3 理解数据物理生成机制
* **Human-in-the-loop**：理解数据背后的物理测量过程（曝光时间、红移、探测器死区）。
* **不清洗标签原则**：深度学习对随机噪声鲁棒，但对**系统性偏差**敏感。除非确认是标注错误，否则不要轻易剔除“看起来奇怪”的数据——它们可能包含新物理现象。

## 三、 模型构建与调优：科学方法论

### 3.1 快速启动与迭代
* **重用原则**：优先复现相关论文的模型，不要从头发明架构。
* **快速搭建**：建立端到端流程（数据 -> 训练 -> **物理指标评估** -> 可视化），先跑通再优化。

### 3.2 调优策略：探索与利用
* **Batch Size**：在显存允许下开到最大以最大化吞吐量。不要用 Batch Size 调优精度。
* **优化器**：起步使用 Adam ($\beta_1=0.9, \beta_2=0.999$)。
* **超参数搜索**：
    * **探索阶段**：使用 **Quasi-Random Search** (如 Halton 序列)。这比网格搜索高效，且能通过“超参数轴图”揭示物理参数对模型性能的敏感度。
    * **利用阶段**：贝叶斯优化。

### 3.3 训练时长与计算预算
* **受限计算**：多轮策略。Round 1 短时间高并行筛选架构；Round 2 选最佳架构长时训练。
* **故障排查**：
    * **早期不稳定**：使用 Learning Rate Warmup。
    * **梯度尖峰**：使用 Gradient Clipping（基于梯度范数 90 分位）。

## 四、 科学评估：超越准确率

在 AI4S 中，模型不仅要准，还要“懂”物理。

### 4.1 不确定性量化 (Uncertainty Quantification)
**必须输出预测的可信度**，而非单纯的点估计。
* **方法**：Bayesian NN, Monte Carlo Dropout, Deep Ensembles, Quantile Regression。
* **区分不确定性来源**：
    * *Aleatoric*（数据本身的统计噪声，如光子噪声）。
    * *Epistemic*（模型知识不足，如未见过的天体类型）。

### 4.2 物理可解释性 (Human Learning)
把模型当作科研伙伴，问它：“你为什么这么预测？”
* **特征重要性**：使用 SHAP 或 Permutation Importance 分析哪些物理参数主导了结果。
* **消融实验 (Ablation Studies)**：移除某个输入通道（如某个波段），观察性能下降，验证物理直觉。
* **可视化**：t-SNE 降维、Saliency Maps、中间层激活分布。

### 4.3 误差分析：物理归因
不要只看 Loss 曲线，要看**物理行为**。
* **行为分析**：绘制 Confusion Matrix，检查边界案例 (Edge Cases)。
* **残差图**：绘制 $(y_{pred} - y_{true})$ 与物理量（如信噪比、红移、质量）的关系。如果残差随某个物理量有系统性变化，说明模型未学到该物理规律。

## 五、 工程指引与科研沟通

### 5.1 实验管理与复现
* **实验追踪**：使用 MLflow/W&B/电子表格记录每一次实验的：配置、Git Commit、物理假设、最佳 Checkpoint 指标。
* **检查点策略**：按固定 **Step** 保存，回顾性选择验证集最佳模型（Retrospective Checkpoint Selection）。
* **开放科学**：开源代码、权重、配置和**训练日志**。让同行能复现你的“失败尝试”，避免重复造轮子。

### 5.2 沟通：图表为主
* 向天文学家/物理学家汇报时，少放代码，多放：
    * **物理残差图**。
    * **置信度分布图**。
    * **典型错误案例（失败分析）**。

### 5.3 十条黄金建议
1.  **从明确的科学问题出发**，而非“尝试模型”。
2.  **定义“成功”**：不仅是高分，更是对科学发现的贡献。
3.  **建立基线**：Dummy -> Historical -> Simple NN。
4.  **理解数据**：物理测量机制、仪器偏差与噪声来源。
5.  **正视偏移**：严防仿真与观测数据的分布偏移 (Sim2Real)。
6.  **拥抱不确定性**：给每一个预测加上 Error Bar。
7.  **解释模型**：利用 AI 发现新物理，而不仅仅是拟合数据。
8.  **正交化调试**：一次只解决一个问题（拟合、泛化、分布偏移）。
9.  **系统性调优**：使用科学的实验设计（Quasi-Random Search）而非随机试错。
10. **全流程开放**：可复现性是科学的基石。

## 附录：AI4S 常用检查清单

* [ ] **目标**：科学决策句是否清晰？Baseline 分数是多少？
* [ ] **数据**：Dev/Test 集是否纯净（无仿真混入）？是否检查了 Covariate Shift？
* [ ] **模型**：是否从简单模型开始？是否使用了 Warmup 防止早期崩塌？
* [ ] **评估**：是否量化了不确定性？是否检查了物理残差？
* [ ] **代码**：是否分离了配置与代码？是否记录了随机种子？